<!DOCTYPE html>
<html lang="zh-tw">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="description" content="不知道星期天要吃什麼嗎？輸入你的選擇，交給命運來決定！" />
<meta name="author" content="xNedKx" />
<meta name="copyright" content="xNedKx" />
<title>星期天吃什麼</title>
<style>
document, body {
  margin: 0;
  background-color: #f0f0f0;
  text-align: center;
  font-family: "PT Sans Narrow", "Meiryo", "MS PGothic", "Apple LiGothic", "文泉驛正黑體", "SimHei", "Microsoft YaHei", "Microsoft JhengHei";
  font-size: 16px;
  color: #111;
  width: 100vw;
  height: 100vh;
  overflow-x: hidden;
  overflow-y: auto;
}
main {
  width: 100%;
  max-width: 600px;
  margin: 0 auto;
  overflow-x: hidden;
}
h1 {
  background-color: #f9f9f9;
  margin: 0 auto;
  padding: 0.3em 0 0.2em;
  font-size: 2.5em;
}
button, input[type=button], input[type=submit] {
  border: 0;
  border-radius: 0.2em;
  padding: 0.2em 0.6em;
  font-size: 0.8em;
  color: #333;
  vertical-align: middle;
  cursor: pointer;
}
input {
  border: 0;
  padding: 0.1em;
  font-size: 1.2em;
  vertical-align: middle;
}
ol, ul {
  margin: 0;
  padding: 0 0 0.5em;
}
li {
  list-style: none;
  padding: 0.1em 0;
}
ul > li:nth-child(odd){
  background-color: rgba(0,0,0,0.02);
}
ul > li:nth-child(even){
  background-color: rgba(0,0,0,0.01);
}
ul > li {
  display: flex;
  flex-wrap: no-wrap;
}
ul > li > div {
  width: 100%;
  font-weight: bold;
  font-size: 1.2em;
}
ul > li > button {
  width: 20%;
  max-width: 42px;
  display: block;
}
ol > li {
  position: relative;
}
.bar {
  position: absolute;
  height: 100%;
  width: 100%;
  transform-origin: left;
  top: 0;
  left: 0;
  will-change: transform;
  transition: transform 50ms;
}
li:nth-child(odd) > .bar {
  background-color: rgba(0,0,0,0.1);
}
li:nth-child(even) > .bar {
  background-color: rgba(0,0,0,0.15);
}
li:nth-child(1) > .bar {
  background-color: rgba(255,104,66,0.5);
}
li:nth-child(1) > .label {
  color: #333;
}
.label {
  position: relative;
  z-index: 10;
}
.label > span:nth-child(1) {
  white-space: pre;
}
#text {
  width: 200px;
}
#numbers {
  width: 3em;
  text-align: center;
}
#add {
  background-color: #bdcaff;
}
#random {
  background-color: #ffcabd;
  transform: scale(1.2) translateX(0.4em);
  transform-origin: center;
}
#f {
  margin: 0.5em 0;
}
#output {
  padding-top: 0.5em;
}
#log {
  height: 300px;
  width: 100%;
  overflow-y: auto;
  overflow-x: hidden;
  text-align: center;
  background-color: #f9f9f9;
  margin: 0;
}
#total {
  color: #666;
}
#total > li:nth-child(odd){
  background-color: rgba(0,0,0,0.01);
}
#total > li:nth-child(even){
  background-color: rgba(0,0,0,0.02);
}
#total > li:nth-child(1){
  background-color: #ffcabd;
}
.opt {
  font-weight: bold;
  font-size: 1.2em;
  color: #111;
}
</style>
</head>
<body>
<main>
<h1>星期天吃什麼</h1>
<div>
  <ul id="options">
  </ul>
  <form id="f" href="#"><label><input id="text" placeholder="想吃什麼？"> <input type="submit" id="add" value="增加選項"></label></form>
  <label>抉擇次數: <input id="numbers" placeholder="50" value=50> <button id="random">幫我決定</button></label>
</div>
<div id="output">
  <div><ol id="total"></ol></div>
  <pre id="log"></pre>
</div>
</main>
<script>
window.addEventListener("DOMContentLoaded", function(){

  var list = document.getElementById("options");
  var add = document.getElementById("add");
  var form = document.getElementById("f");
  var ran = document.getElementById("random");
  var text = document.getElementById("text");
  var numb = document.getElementById("numbers");
  var log = document.getElementById("log");
  var sum = document.getElementById("total");
  
  var analyse = {};
  var saveOptions;
  var running = 0;
  var timer, times;
  var labels = {};

  if(localStorage){
    saveOptions = (localStorage.getItem("options") || "").split("|");
    for( var i = 0; i < saveOptions.length; i++ ){
      if(saveOptions[i]){
        analyse[saveOptions[i]] = 0;
        addItem(saveOptions[i]);
      }
    }
  }

  function addItem(text){
    var op = document.createElement("li");
    var d = document.createElement("div");
    d.innerText = text;
    op.appendChild(d);
    d = document.createElement("button");
    d.innerText = "X";
    d.addEventListener("click", removeOption, false);
    op.appendChild(d);
    op.dataset.option = text;
    list.appendChild(op);
    return op;
  }

  function addOption(e){
    e.preventDefault();
    if(text.value == "" || analyse.hasOwnProperty(text.value)){
      text.select();
      text.focus();
      return;
    }
    if(timer){
      clearInterval(timer);
      timer = 0;
      running = 0;
    }
    if(localStorage){
      saveOptions.push(text.value);
      localStorage.setItem("options", saveOptions.join("|"));
    }
    analyse[text.value] = 0;
    addItem(text.value);
    text.value = "";
    text.focus();
    return;
  }

  function removeOption(e){
    var option = e.target.parentNode;
    delete analyse[option.dataset.option];
    option.parentNode.removeChild(option);
    if(localStorage){
      var i = saveOptions.indexOf(option.dataset.option);
      if( i != -1 ){
        saveOptions.splice(i, 1);
      }
      localStorage.setItem("options", saveOptions.join("|"));
    }
    if(timer){
      clearInterval(timer);
      timer = 0;
      running = 0;
    }
  }

  function vote(){
    if(running > 0){
      var options = Object.keys(analyse);
      var index = Math.floor(Math.random() * options.length);
      log.innerText += options[index] + " 一票\n";
      log.scrollTop = log.scrollHeight;
      analyse[options[index]]++;
      running--;
      var output = [];
      for( i in analyse ){
        output.push({o: i, n: analyse[i]});
      }
      output.sort(function(a,b){return b.n - a.n});
      output.forEach(function(op, i){
        var percent = Math.round(10000 * op.n / (times - running)) / 100;
        sum.appendChild(labels[op.o]);
        labels[op.o].children[0].style.transform = "scaleX(" + (percent / 100 * Math.pow(output.length, 1/2)) + ")";
        labels[op.o].children[1].children[0].innerText = percent;
        labels[op.o].children[1].children[2].innerText = op.n;
      });
    }else{
      clearInterval(timer);
      timer = 0;
    }
  }

  function run(e){
    if(Object.keys(analyse).length && running == 0){
      var n = +numb.value;
      if(!(isFinite(n) && n > 0)){
        n = 50;
        numb.value = n;
      }
      times = running = n;
      while(sum.children.length){
        sum.removeChild(sum.children[0]);
      }
      var li, d;
      labels = {};
      for( i in analyse ){
        analyse[i] = 0;
        li = document.createElement("li");
        d = document.createElement("div");
        d.className = "bar";
        li.appendChild(d);
        d = document.createElement("div");
        d.className = "label";
        d.innerHTML = "<span>" + 0 + "</span>% <span class='opt'>" + i + "</span> [<span>" + 0 + "</span>票]";
        li.appendChild(d);
        sum.appendChild(li);
        labels[i] = li;
      }
      log.innerText = "";
      timer = setInterval(function(){requestAnimationFrame(vote)}, 400 * Math.pow(Math.log(n), 2) * Math.pow(n, 1 / n) / n);
    }
  }

  f.addEventListener("submit", addOption);
  ran.addEventListener("click", run);

  text.focus();

});
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-78696465-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>
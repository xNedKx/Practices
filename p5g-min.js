function place(e,t){var o,r=e+t*w,i=d;l+1>cur?r>=0&&l>r&&0===map[r]&&(map[r]=cur,hist[cur-1]=r,0===e?(i&=~L,cd[r]|=mDL|mL|mLU|bDL|bL|bLU):e===w-1&&(i&=~R,cd[r]|=mUR|mR|mRD|bUR|bR|bRD),0===t?(i&=~U,cd[r]|=mLU|mU|mUR|bLU|bU|bUR):t===h-1&&(i&=~D,cd[r]|=mRD|mD|mDL|bRD|bD|bDL),i&U&&(o=r-w,map[o]&&(cd[r]|=mU,cd[o]|=mD,(map[r]-map[o])%2&&(cd[r]|=bU,cd[o]|=bD))),i&(U|R)&&(o=r-w+1,map[o]&&(cd[r]|=mUR,cd[o]|=mDL,(map[r]-map[o])%2&&(cd[r]|=bUR,cd[o]|=bDL))),i&R&&(o=r+1,map[o]&&(cd[r]|=mR,cd[o]|=mL,(map[r]-map[o])%2&&(cd[r]|=bR,cd[o]|=bL))),i&(R|D)&&(o=r+1+w,map[o]&&(cd[r]|=mRD,cd[o]|=mLU,(map[r]-map[o])%2&&(cd[r]|=bRD,cd[o]|=bLU))),i&D&&(o=r+w,map[o]&&(cd[r]|=mD,cd[o]|=mU,(map[r]-map[o])%2&&(cd[r]|=bD,cd[o]|=bU))),i&(D|L)&&(o=r+w-1,map[o]&&(cd[r]|=mDL,cd[o]|=mUR,(map[r]-map[o])%2&&(cd[r]|=bDL,cd[o]|=bUR))),i&L&&(o=r-1,map[o]&&(cd[r]|=mL,cd[o]|=mR,(map[r]-map[o])%2&&(cd[r]|=bL,cd[o]|=bR))),i&(L|U)&&(o=r-1-w,map[o]&&(cd[r]|=mLU,cd[o]|=mRD,(map[r]-map[o])%2&&(cd[r]|=bLU,cd[o]|=bRD))),check(),cur+=1):void 0===wp?console.log("It`s a tie."):console.log("Player",pl+1,"wins.")}function check(){if(cur===l)console.log("TIE");else{for(var e={},t={},o={},r="",i=0,p=0;cur>p;p++){for(var d=hist[p],n=d,c=[[],[],[],[],[],[],[],[]];cd[n]&mU&&!(cd[n]&bU);)n-=w,c[7].push(n);for(n=d;cd[n]&mUR&&!(cd[n]&bUR);)n=n-w+1,c[6].push(n);for(n=d;cd[n]&mR&&!(cd[n]&bR);)n+=1,c[5].push(n);for(n=d;cd[n]&mRD&&!(cd[n]&bRD);)n=n+1+w,c[4].push(n);for(n=d;cd[n]&mD&&!(cd[n]&bD);)n+=w,c[3].push(n);for(n=d;cd[n]&mDL&&!(cd[n]&bDL);)n=n+w-1,c[2].push(n);for(n=d;cd[n]&mL&&!(cd[n]&bL);)n-=1,c[1].push(n);for(n=d;cd[n]&mLU&&!(cd[n]&bLU);)n=n-1-w,c[0].push(n);i=c[0].length+c[4].length+1,r=c[0].reverse().concat(d).concat(c[4]).join(";"),vp>i||e.hasOwnProperty(r)?i!==vp-1||t.hasOwnProperty(r)?i!==vp-2||o.hasOwnProperty(r)||(o[r]=cur):t[r]=cur:e[r]=cur,i=c[1].length+c[5].length+1,r=c[1].reverse().concat(d).concat(c[5]).join(";"),vp>i||e.hasOwnProperty(r)?i!==vp-1||t.hasOwnProperty(r)?i!==vp-2||o.hasOwnProperty(r)||(o[r]=cur):t[r]=cur:e[r]=cur,i=c[6].length+c[2].length+1,r=c[6].reverse().concat(d).concat(c[2]).join(";"),vp>i||e.hasOwnProperty(r)?i!==vp-1||t.hasOwnProperty(r)?i!==vp-2||o.hasOwnProperty(r)||(o[r]=cur):t[r]=cur:e[r]=cur,i=c[7].length+c[3].length+1,r=c[7].reverse().concat(d).concat(c[3]).join(";"),vp>i||e.hasOwnProperty(r)?i!==vp-1||t.hasOwnProperty(r)?i!==vp-2||o.hasOwnProperty(r)||(o[r]=cur):t[r]=cur:e[r]=cur}var a=Object.keys(e),s=Object.keys(t),h=Object.keys(o),m=[];for(p=0;p<a.length;p++)m=a[p].split(";"),m.forEach(function(e){pat[e]=vp});for(p=0;p<s.length;p++)m=s[p].split(";"),m.forEach(function(e){pat[e]<vp-1&&(pat[e]=vp-1)});for(p=0;p<h.length;p++)m=h[p].split(";"),m.forEach(function(e){pat[e]<vp-2&&(pat[e]=vp-2)});a.length&&win((cur-1)%2)}}function win(e){cur=l+1,wp=e,console.log("Player",e+1,"wins.")}function save(){return JSON.stringify({w:w,h:h,hist:Array.prototype.slice.call(hist,0,cur-1)})}function load(e){try{var t=JSON.parse(e);reset(t.w,t.h);for(var o=0;o<t.hist.length;o++){var r=t.hist[o]%t.w,i=(t.hist[o]-r)/t.w;place(r,i)}}catch(p){console.log(p)}}function reset(e,t){e=isFinite(e)?+e:dw,t=isFinite(t)?+t:dh,w=7>e?7:e>256?256:e,h=7>t?7:t>256?256:t,l=w*h,map=new Uint16Array(l),hist=new Uint16Array(l),cd=new Uint16Array(l),cur=1,pat=new Uint16Array(l)}function display(){for(var e="",t=0;l>t;t++)e+=map[t]?map[t]%2?"O":"X":" ",(t+1)%w===0&&(console.log(e),e="")}function display_p(){for(var e="",t=0;l>t;t++)e+=pat[t]?pat[t]:" ",(t+1)%w===0&&(console.log(e),e="")}function refresh_dom(){for(var e=document.getElementsByClassName("point"),t=0;cur+1>t;t++){var o=hist[t];e[o].className+=" p"+((map[o]-1)%2+1),e[o].removeEventListener("click",dom_event),pat[o]?pat[o]>+e[o].firstChild.innerHTML&&(e[o].firstChild.innerHTML=pat[o]):e[o].firstChild.innerHTML=""}if(cur>=l+1){for(var t=0;t<e.length;t++)e[t].removeEventListener("click",dom_event);alert(void 0===wp?"It`s a tie.":"Player "+(wp+1)+" wins."),document.getElementById("gs").innerHTML="#dg { width: "+22*w+"px; height: "+22*h+"px; display: inline-block; } .point { background-color: #EEE; width: 20px; height: 20px; float: left; line-height: 20px; font-size: 12px; text-align: center; padding: 1px; position: relative; } .point > .cir { width: 20px; height: 20px; border-radius: 10px; z-index: 10; position: absolute; top: 1px; left: 1px; } .p1>.cir { background-color: #D99 } .p2>.cir { background-color: #99D; } .bo { position: absolute; box-sizing: border-box; width: 11px; height: 11px; } .l1 { top: 0; left: 0; border-right: 1px solid #666; border-bottom: 1px solid #666; } .l2 { top: 0; left: 11px; border-left: 1px solid #666; border-bottom: 1px solid #666; } .l3 { top: 11px; left: 0; border-right: 1px solid #666; border-top: 1px solid #666; } .l4 { top: 11px; left: 11px; border-left: 1px solid #666; border-top: 1px solid #666; }"}}function dom_event(e){if(0===e.button){e.preventDefault(),this.removeEventListener("click",dom_event),this.className+=" p"+((cur-1)%2+1),place(this.x,this.y);for(var t=document.getElementsByClassName("point"),o=0;o<t.length;o++){var r=t[o].y*w+t[o].x;pat[r]?pat[r]>+t[o].firstChild.innerHTML&&(t[o].firstChild.innerHTML=pat[r]):t[o].firstChild.innerHTML="",l+1>cur||t[o].removeEventListener("click",dom_event)}document.getElementById("gs").innerHTML="#dg { width: "+22*w+"px; height: "+22*h+"px; display: inline-block; } .point { background-color: "+((cur-1)%2?"#DDF":"#FDD")+"; width: 20px; height: 20px; float: left; line-height: 20px; font-size: 12px; text-align: center; padding: 1px; position: relative; } .point > .cir { width: 20px; height: 20px; border-radius: 10px; z-index: 10; position: absolute; top: 1px; left: 1px; } .point>.cir:hover { background-color: #FFF; cursor: pointer; } .p1>.cir,.p1>.cir:hover { background-color: #D99; cursor: default; } .p2>.cir,.p2>.cir:hover { background-color: #99D; cursor: default; } .bo { position: absolute; box-sizing: border-box; width: 11px; height: 11px; } .l1 { top: 0; left: 0; border-right: 1px solid #666; border-bottom: 1px solid #666; } .l2 { top: 0; left: 11px; border-left: 1px solid #666; border-bottom: 1px solid #666; } .l3 { top: 11px; left: 0; border-right: 1px solid #666; border-top: 1px solid #666; } .l4 { top: 11px; left: 11px; border-left: 1px solid #666; border-top: 1px solid #666; }",l+1>cur||(alert(void 0===wp?"It`s a tie.":"Player "+(wp+1)+" wins."),document.getElementById("gs").innerHTML="#dg { width: "+22*w+"px; height: "+22*h+"px; display: inline-block; } .point { background-color: #EEE; width: 20px; height: 20px; float: left; line-height: 20px; font-size: 12px; text-align: center; padding: 1px; position: relative; } .point > .cir { width: 20px; height: 20px; border-radius: 10px; z-index: 10; position: absolute; top: 1px; left: 1px; } .p1>.cir { background-color: #D99 } .p2>.cir { background-color: #99D; } .bo { position: absolute; box-sizing: border-box; width: 11px; height: 11px; } .l1 { top: 0; left: 0; border-right: 1px solid #666; border-bottom: 1px solid #666; } .l2 { top: 0; left: 11px; border-left: 1px solid #666; border-bottom: 1px solid #666; } .l3 { top: 11px; left: 0; border-right: 1px solid #666; border-top: 1px solid #666; } .l4 { top: 11px; left: 11px; border-left: 1px solid #666; border-top: 1px solid #666; }")}}function create_dom(e,t,o){var r=document.createElement("div"),i=document.createElement("style"),p=document.getElementById("gs"),d=document.getElementById("dg");d&&d.parentNode.removeChild(d),p&&p.parentNode.removeChild(p),reset(t,o),r.id="dg",i.id="gs",i.innerHTML="#dg { width: "+22*w+"px; height: "+22*h+"px; display: inline-block; } .point { background-color: #EEE; width: 20px; height: 20px; float: left; line-height: 20px; font-size: 12px; text-align: center; padding: 1px; position: relative; } .point > .cir { width: 20px; height: 20px; border-radius: 10px; z-index: 10; position: absolute; top: 1px; left: 1px; } .point>.cir:hover { background-color: #FFF; cursor: pointer; } .p1>.cir,.p1>.cir:hover { background-color: #D99; cursor: default; } .p2>.cir,.p2>.cir:hover { background-color: #99D; cursor: default; } .bo { position: absolute; box-sizing: border-box; width: 11px; height: 11px; } .l1 { top: 0; left: 0; border-right: 1px solid #666; border-bottom: 1px solid #666; } .l2 { top: 0; left: 11px; border-left: 1px solid #666; border-bottom: 1px solid #666; } .l3 { top: 11px; left: 0; border-right: 1px solid #666; border-top: 1px solid #666; } .l4 { top: 11px; left: 11px; border-left: 1px solid #666; border-top: 1px solid #666; }";for(var l=0;h>l;l++){for(var n=document.createElement("div"),c=0;w>c;c++){var a=document.createElement("div");a.className="point",a.x=c,a.y=l,a.addEventListener("click",dom_event),a.appendChild(document.createElement("div")),a.firstChild.className="cir",a.appendChild(document.createElement("div")),a.lastChild.className="bo"+(0===c||0===l?"":" l1"),a.appendChild(document.createElement("div")),a.lastChild.className="bo"+(c===w-1||0===l?"":" l2"),a.appendChild(document.createElement("div")),a.lastChild.className="bo"+(0===c||l===h-1?"":" l3"),a.appendChild(document.createElement("div")),a.lastChild.className="bo"+(c===w-1||l===h-1?"":" l4"),n.appendChild(a)}n.appendChild(document.createElement("div")),n.lastChild.style.clear="both",r.appendChild(n)}e.appendChild(r),document.body.appendChild(i)}var vp=5,dw=32,dh=32,w=dw,h=dh,l=w*h,map=new Uint16Array(l),hist=new Uint16Array(l),cd=new Uint16Array(l),cur=1,wp,pat=new Uint16Array(l),U=8,R=4,D=2,L=1,d=U|R|D|L,mU=32768,mUR=16384,mR=8192,mRD=4096,mD=2048,mDL=1024,mL=512,mLU=256,bU=128,bUR=64,bR=32,bRD=16,bD=8,bDL=4,bL=2,bLU=1,mA=~(mU|mUR|mR|mRD|mD|mDL|mL|mLU);